FMS = FMS * ((t(vect2) %*% vect1))
}
for(p in 1:numDatasets){
ksi_hat = ksi_hat + normalizedFac$normsPerDataset[p,i]
ksi = ksi + normalizedInputFac$normsPerDataset[p,j]
}
ksi_term = ((abs(ksi - ksi_hat)) / max(ksi, ksi_hat))
proposedFMS[j] = (1 - ksi_term) * abs(FMS)
}
FMS_result[i] = max(proposedFMS)
}
return(min(FMS_result))
}
R = 3
I = 50
J = 50
K = 50
L = 50
modes = list(c(1,2,3), c(1,4))
# Generate loading matrices, normalize each vector to 1
A = array(rnorm(I*R), c(I, R))  # shared subject mode
Anorm = sweep(A, 2, apply(A, 2, function(x){norm(as.matrix(x), "F")}), FUN="/")
B = array(rnorm(J*R), c(J, R))  # distinct feature mode of X1
Bnorm = sweep(B, 2, apply(B, 2, function(x){norm(as.matrix(x), "F")}), FUN="/")
C = array(rnorm(K*R), c(K, R))  # distinct condition mode of X1
Cnorm = sweep(C, 2, apply(C, 2, function(x){norm(as.matrix(x), "F")}), FUN="/")
D = array(rnorm(L*R), c(L, R))  # distinct feature mode of X2
Dnorm = sweep(D, 2, apply(D, 2, function(x){norm(as.matrix(x), "F")}), FUN="/")
# Generate datasets without noise
df1 = as.tensor(reinflateTensor(A, B, C))
df2 = as.tensor(reinflateMatrix(A, D))
df1norm = as.tensor(reinflateTensor(Anorm, Bnorm, Cnorm))
df2norm = as.tensor(reinflateMatrix(Anorm, Dnorm))
# Generate noise
df1_noise = as.tensor(array(rnorm(I*J*K), c(I,J,K)))
df2_noise = as.tensor(array(rnorm(I*L), c(I,L)))
# Create final datasets by adding the noise of different sizes to the generated data
X1_010 = df1 + 0.10 * df1_noise * fnorm(df1) / fnorm(df1_noise)
X1_025 = df1 + 0.25 * df1_noise * fnorm(df1) / fnorm(df1_noise)
X1_035 = df1 + 0.35 * df1_noise * fnorm(df1) / fnorm(df1_noise)
X2_010 = df2 + 0.10 * df2_noise * fnorm(df2) / fnorm(df2_noise)
X2_025 = df2 + 0.25 * df2_noise * fnorm(df2) / fnorm(df2_noise)
X2_035 = df2 + 0.35 * df2_noise * fnorm(df2) / fnorm(df2_noise)
X1_010_norm = df1norm + 0.10 * df1_noise * fnorm(df1norm) / fnorm(df1_noise)
X1_025_norm = df1norm + 0.25 * df1_noise * fnorm(df1norm) / fnorm(df1_noise)
X1_035_norm = df1norm + 0.35 * df1_noise * fnorm(df1norm) / fnorm(df1_noise)
X2_010_norm = df2norm + 0.10 * df2_noise * fnorm(df2norm) / fnorm(df2_noise)
X2_025_norm = df2norm + 0.25 * df2_noise * fnorm(df2norm) / fnorm(df2_noise)
X2_035_norm = df2norm + 0.35 * df2_noise * fnorm(df2norm) / fnorm(df2_noise)
# Prepare CMTF input
Z_010 = setupCMTFdata(list(X1_010@data, X2_010@data), modes, normalize=FALSE)
Z_025 = setupCMTFdata(list(X1_025@data, X2_025@data), modes, normalize=FALSE)
Z_035 = setupCMTFdata(list(X1_035@data, X2_035@data), modes, normalize=FALSE)
Z_010_norm = setupCMTFdata(list(X1_010_norm@data, X2_010_norm@data), modes, normalize=FALSE)
Z_025_norm = setupCMTFdata(list(X1_025_norm@data, X2_025_norm@data), modes, normalize=FALSE)
Z_035_norm = setupCMTFdata(list(X1_035_norm@data, X2_035_norm@data), modes, normalize=FALSE)
# Settings
nstart = 10
rel_tol = 1e-8
grad_tol = 1e-8
max_fn = 10^4
max_iter = 10^3
numCores = detectCores()
print(numCores)
CMTF_010 = cmtf_opt(Z_010, R, initialization="random", rel_tol=rel_tol, grad_tol=grad_tol, max_fn=max_fn, max_iter=max_iter, nstart=nstart, numCores=numCores, allOutput=TRUE)
CMTF_025 = cmtf_opt(Z_025, R, initialization="random", rel_tol=rel_tol, grad_tol=grad_tol, max_fn=max_fn, max_iter=max_iter, nstart=nstart, numCores=numCores, allOutput=TRUE)
CMTF_035 = cmtf_opt(Z_035, R, initialization="random", rel_tol=rel_tol, grad_tol=grad_tol, max_fn=max_fn, max_iter=max_iter, nstart=nstart, numCores=numCores, allOutput=TRUE)
CMTF_010_norm = cmtf_opt(Z_010_norm, R, initialization="random", rel_tol=rel_tol, grad_tol=grad_tol, max_fn=max_fn, max_iter=max_iter, nstart=nstart, numCores=numCores, allOutput=TRUE)
CMTF_025_norm = cmtf_opt(Z_025_norm, R, initialization="random", rel_tol=rel_tol, grad_tol=grad_tol, max_fn=max_fn, max_iter=max_iter, nstart=nstart, numCores=numCores, allOutput=TRUE)
CMTF_035_norm = cmtf_opt(Z_035_norm, R, initialization="random", rel_tol=rel_tol, grad_tol=grad_tol, max_fn=max_fn, max_iter=max_iter, nstart=nstart, numCores=numCores, allOutput=TRUE)
# Recreate input Fac using the component sizes to sort by size
inputFac = list(A, B, C, D)
inputFacnorm = list(Anorm, Bnorm, Cnorm, Dnorm)
result_Tensor_Matrix = array(0L, c(6, length(CMTF_010)))
for(i in 1:length(CMTF_010)){
result_Tensor_Matrix[1,i] = FMS_to_simulation(inputFac, CMTF_010[[i]]$Fac, modes)
result_Tensor_Matrix[2,i] = FMS_to_simulation(inputFac, CMTF_025[[i]]$Fac, modes)
result_Tensor_Matrix[3,i] = FMS_to_simulation(inputFac, CMTF_035[[i]]$Fac, modes)
result_Tensor_Matrix[4,i] = FMS_to_simulation(inputFacnorm, CMTF_010_norm[[i]]$Fac, modes)
result_Tensor_Matrix[5,i] = FMS_to_simulation(inputFacnorm, CMTF_025_norm[[i]]$Fac, modes)
result_Tensor_Matrix[6,i] = FMS_to_simulation(inputFacnorm, CMTF_035_norm[[i]]$Fac, modes)
}
result_Tensor_Matrix
rowSums((result_Tensor_Matrix > 0.99^4) / nstart) * 100
rowMeans(result_Tensor_Matrix)
library(CMTFtoolbox)
library(tidyverse)
library(ggpubr)
set.seed(123)
R = 3
I = 50
J = 30
K = 40
M = 20
modes = list(c(1,2,3), c(1,4))
A = array(rnorm(I*R), c(I, R))  # shared subject mode
Anorm = sweep(A, 2, apply(A, 2, function(x){norm(as.matrix(x), "F")}), FUN="/")
B = array(rnorm(J*R), c(J, R))  # distinct feature mode of X1
Bnorm = sweep(B, 2, apply(B, 2, function(x){norm(as.matrix(x), "F")}), FUN="/")
C = array(rnorm(K*R), c(K, R))  # distinct condition mode of X1
Cnorm = sweep(C, 2, apply(C, 2, function(x){norm(as.matrix(x), "F")}), FUN="/")
D = array(rnorm(M*R), c(M, R))  # distinct feature mode of X2
Dnorm = sweep(D, 2, apply(D, 2, function(x){norm(as.matrix(x), "F")}), FUN="/")
lambdas = array(c(1, 1, 0, 1, 1, 1), c(2,3))
df1 = array(0L, c(I, J, K))
df2 = array(0L, c(I, M))
for(i in 1:R){
df1 = df1 + lambdas[1,i] * reinflateTensor(Anorm[,i], Bnorm[,i], Cnorm[,i])
df2 = df2 + lambdas[2,i] * reinflateMatrix(Anorm[,i], Dnorm[,i])
}
datasets = list(df1, df2)
Z = setupCMTFdata(datasets, modes, normalize=TRUE)
cmtf_result = cmtf_opt(Z, 3, nstart=10, numCores=10)
acmtf_result = acmtf_opt(Z, 3, nstart=10, numCores=10)
# CMTF best result
plotlist_cmtf = list()
plotlist_cmtf[[1]]  = cbind(Anorm, cmtf_result$Fac[[1]]) %>% as_tibble() %>% ggplot(aes(x=V1, y=V4)) + geom_point() + ggtitle("Subject mode (shared)") + xlab("") + ylab("Modelled loading (Comp. 1)")
plotlist_cmtf[[2]]  = cbind(Bnorm, cmtf_result$Fac[[2]]) %>% as_tibble() %>% ggplot(aes(x=V1, y=V4)) + geom_point() + ggtitle("Feature mode X1") + xlab("") + ylab("")
plotlist_cmtf[[3]]  = cbind(Cnorm, cmtf_result$Fac[[3]]) %>% as_tibble() %>% ggplot(aes(x=V1, y=V4)) + geom_point() + ggtitle("Condition mode X1") + xlab("") + ylab("")
plotlist_cmtf[[4]]  = cbind(Dnorm, cmtf_result$Fac[[4]]) %>% as_tibble() %>% ggplot(aes(x=V1, y=V4)) + geom_point() + ggtitle("Feature mode X2") + xlab("") + ylab("")
plotlist_cmtf[[5]]  = cbind(Anorm, cmtf_result$Fac[[1]]) %>% as_tibble() %>% ggplot(aes(x=V2, y=V6)) + geom_point() + xlab("") + ylab("Modelled loading (Comp. 2)")
plotlist_cmtf[[6]]  = cbind(Bnorm, cmtf_result$Fac[[2]]) %>% as_tibble() %>% ggplot(aes(x=V2, y=V6)) + geom_point() + xlab("") + ylab("")
plotlist_cmtf[[7]]  = cbind(Cnorm, cmtf_result$Fac[[3]]) %>% as_tibble() %>% ggplot(aes(x=V2, y=V6)) + geom_point() + xlab("") + ylab("")
plotlist_cmtf[[8]]  = cbind(Dnorm, cmtf_result$Fac[[4]]) %>% as_tibble() %>% ggplot(aes(x=V2, y=V6)) + geom_point() + xlab("") + ylab("")
plotlist_cmtf[[9]]  = cbind(Anorm, cmtf_result$Fac[[1]]) %>% as_tibble() %>% ggplot(aes(x=V3, y=V5)) + geom_point() + xlab("Simulated loading") + ylab("Modelled loading (Comp. 3)")
plotlist_cmtf[[10]] = cbind(Bnorm, cmtf_result$Fac[[2]]) %>% as_tibble() %>% ggplot(aes(x=V3, y=V5)) + geom_point() + xlab("Simulated loading") + ylab("")
plotlist_cmtf[[11]] = cbind(Cnorm, cmtf_result$Fac[[3]]) %>% as_tibble() %>% ggplot(aes(x=V3, y=V5)) + geom_point() + xlab("Simulated loading") + ylab("")
plotlist_cmtf[[12]] = cbind(Dnorm, cmtf_result$Fac[[4]]) %>% as_tibble() %>% ggplot(aes(x=V3, y=V5)) + geom_point() + xlab("Simulated loading") + ylab("")
plot = ggarrange(plotlist=plotlist_cmtf, nrow=3, ncol=4)
annotate_figure(plot, top = text_grob("CMTF model"))
abs(t(cmtf_result$Fac[[1]][,1]) %*% Anorm[,1]) / (norm(as.matrix(cmtf_result$Fac[[1]][,1]), "F") * norm(as.matrix(Anorm[,1]), "F"))
abs(t(cmtf_result$Fac[[1]][,3]) %*% Anorm[,2]) / (norm(as.matrix(cmtf_result$Fac[[1]][,3]), "F") * norm(as.matrix(Anorm[,2]), "F"))
abs(t(cmtf_result$Fac[[1]][,2]) %*% Anorm[,3]) / (norm(as.matrix(cmtf_result$Fac[[1]][,2]), "F") * norm(as.matrix(Anorm[,3]), "F"))
# CMTF best result
plotlist_acmtf = list()
plotlist_acmtf[[1]]  = cbind(Anorm, acmtf_result$Fac[[1]]) %>% as_tibble() %>% ggplot(aes(x=V1, y=V5)) + geom_point() + ggtitle("Subject mode (shared)") + xlab("") + ylab("Modelled loading (Comp. 1)")
plotlist_acmtf[[2]]  = cbind(Bnorm, acmtf_result$Fac[[2]]) %>% as_tibble() %>% ggplot(aes(x=V1, y=V5)) + geom_point() + ggtitle("Feature mode X1") + xlab("") + ylab("")
plotlist_acmtf[[3]]  = cbind(Cnorm, acmtf_result$Fac[[3]]) %>% as_tibble() %>% ggplot(aes(x=V1, y=V5)) + geom_point() + ggtitle("Condition mode X1") + xlab("") + ylab("")
plotlist_acmtf[[4]]  = cbind(Dnorm, acmtf_result$Fac[[4]]) %>% as_tibble() %>% ggplot(aes(x=V1, y=V5)) + geom_point() + ggtitle("Feature mode X2") + xlab("") + ylab("")
plotlist_acmtf[[5]]  = cbind(Anorm, acmtf_result$Fac[[1]]) %>% as_tibble() %>% ggplot(aes(x=V2, y=V4)) + geom_point() + xlab("") + ylab("Modelled loading (Comp. 2)")
plotlist_acmtf[[6]]  = cbind(Bnorm, acmtf_result$Fac[[2]]) %>% as_tibble() %>% ggplot(aes(x=V2, y=V4)) + geom_point() + xlab("") + ylab("")
plotlist_acmtf[[7]]  = cbind(Cnorm, acmtf_result$Fac[[3]]) %>% as_tibble() %>% ggplot(aes(x=V2, y=V4)) + geom_point() + xlab("") + ylab("")
plotlist_acmtf[[8]]  = cbind(Dnorm, acmtf_result$Fac[[4]]) %>% as_tibble() %>% ggplot(aes(x=V2, y=V4)) + geom_point() + xlab("") + ylab("")
plotlist_acmtf[[9]]  = cbind(Anorm, acmtf_result$Fac[[1]]) %>% as_tibble() %>% ggplot(aes(x=V3, y=V6)) + geom_point() + xlab("Simulated loading") + ylab("Modelled loading (Comp. 3)")
plotlist_acmtf[[10]] = cbind(Bnorm, acmtf_result$Fac[[2]]) %>% as_tibble() %>% ggplot(aes(x=V3, y=V6)) + geom_point() + xlab("Simulated loading") + ylab("")
plotlist_acmtf[[11]] = cbind(Cnorm, acmtf_result$Fac[[3]]) %>% as_tibble() %>% ggplot(aes(x=V3, y=V6)) + geom_point() + xlab("Simulated loading") + ylab("")
plotlist_acmtf[[12]] = cbind(Dnorm, acmtf_result$Fac[[4]]) %>% as_tibble() %>% ggplot(aes(x=V3, y=V6)) + geom_point() + xlab("Simulated loading") + ylab("")
plot = ggarrange(plotlist=plotlist_acmtf, nrow=3, ncol=4)
annotate_figure(plot, top = text_grob("acmtf model"))
abs(t(acmtf_result$Fac[[1]][,2]) %*% Anorm[,1]) / (norm(as.matrix(acmtf_result$Fac[[1]][,2]), "F") * norm(as.matrix(Anorm[,1]), "F"))
abs(t(acmtf_result$Fac[[1]][,1]) %*% Anorm[,2]) / (norm(as.matrix(acmtf_result$Fac[[1]][,1]), "F") * norm(as.matrix(Anorm[,2]), "F"))
abs(t(acmtf_result$Fac[[1]][,3]) %*% Anorm[,3]) / (norm(as.matrix(acmtf_result$Fac[[1]][,3]), "F") * norm(as.matrix(Anorm[,3]), "F"))
lambdas
acmtf_result$Fac[[5]]
library(CMTFtoolbox)
library(tidyverse)
library(ggpubr)
set.seed(123)
R = 3
I = 50
J = 30
K = 40
M = 20
modes = list(c(1,2,3), c(1,4))
A = array(rnorm(I*R), c(I, R))  # shared subject mode
Anorm = sweep(A, 2, apply(A, 2, function(x){norm(as.matrix(x), "F")}), FUN="/")
B = array(rnorm(J*R), c(J, R))  # distinct feature mode of X1
Bnorm = sweep(B, 2, apply(B, 2, function(x){norm(as.matrix(x), "F")}), FUN="/")
C = array(rnorm(K*R), c(K, R))  # distinct condition mode of X1
Cnorm = sweep(C, 2, apply(C, 2, function(x){norm(as.matrix(x), "F")}), FUN="/")
D = array(rnorm(M*R), c(M, R))  # distinct feature mode of X2
Dnorm = sweep(D, 2, apply(D, 2, function(x){norm(as.matrix(x), "F")}), FUN="/")
lambdas = array(c(1, 1, 0, 1, 1, 1), c(2,3))
df1 = array(0L, c(I, J, K))
df2 = array(0L, c(I, M))
for(i in 1:R){
df1 = df1 + lambdas[1,i] * reinflateTensor(Anorm[,i], Bnorm[,i], Cnorm[,i])
df2 = df2 + lambdas[2,i] * reinflateMatrix(Anorm[,i], Dnorm[,i])
}
datasets = list(df1, df2)
Z = setupCMTFdata(datasets, modes, normalize=TRUE)
cmtf_result = cmtf_opt(Z, 3, nstart=10, numCores=10)
acmtf_result = acmtf_opt(Z, 3, nstart=10, numCores=10)
library(CMTFtoolbox)
library(tidyverse)
library(ggpubr)
set.seed(123)
R = 3
I = 50
J = 30
K = 40
M = 20
modes = list(c(1,2,3), c(1,4))
A = array(rnorm(I*R), c(I, R))  # shared subject mode
Anorm = sweep(A, 2, apply(A, 2, function(x){norm(as.matrix(x), "F")}), FUN="/")
B = array(rnorm(J*R), c(J, R))  # distinct feature mode of X1
Bnorm = sweep(B, 2, apply(B, 2, function(x){norm(as.matrix(x), "F")}), FUN="/")
C = array(rnorm(K*R), c(K, R))  # distinct condition mode of X1
Cnorm = sweep(C, 2, apply(C, 2, function(x){norm(as.matrix(x), "F")}), FUN="/")
D = array(rnorm(M*R), c(M, R))  # distinct feature mode of X2
Dnorm = sweep(D, 2, apply(D, 2, function(x){norm(as.matrix(x), "F")}), FUN="/")
lambdas = array(c(1, 1, 0, 1, 1, 1), c(2,3))
df1 = array(0L, c(I, J, K))
df2 = array(0L, c(I, M))
for(i in 1:R){
df1 = df1 + lambdas[1,i] * reinflateTensor(Anorm[,i], Bnorm[,i], Cnorm[,i])
df2 = df2 + lambdas[2,i] * reinflateMatrix(Anorm[,i], Dnorm[,i])
}
datasets = list(df1, df2)
Z = setupCMTFdata(datasets, modes, normalize=TRUE)
cmtf_result = cmtf_opt(Z, 3, nstart=10, numCores=10)
acmtf_result = acmtf_opt(Z, 3, nstart=10, numCores=10)
# CMTF best result
plotlist_cmtf = list()
plotlist_cmtf[[1]]  = cbind(Anorm, cmtf_result$Fac[[1]]) %>% as_tibble() %>% ggplot(aes(x=V1, y=V4)) + geom_point() + ggtitle("Subject mode (shared)") + xlab("") + ylab("Modelled loading (Comp. 1)")
plotlist_cmtf[[2]]  = cbind(Bnorm, cmtf_result$Fac[[2]]) %>% as_tibble() %>% ggplot(aes(x=V1, y=V4)) + geom_point() + ggtitle("Feature mode X1") + xlab("") + ylab("")
plotlist_cmtf[[3]]  = cbind(Cnorm, cmtf_result$Fac[[3]]) %>% as_tibble() %>% ggplot(aes(x=V1, y=V4)) + geom_point() + ggtitle("Condition mode X1") + xlab("") + ylab("")
plotlist_cmtf[[4]]  = cbind(Dnorm, cmtf_result$Fac[[4]]) %>% as_tibble() %>% ggplot(aes(x=V1, y=V4)) + geom_point() + ggtitle("Feature mode X2") + xlab("") + ylab("")
plotlist_cmtf[[5]]  = cbind(Anorm, cmtf_result$Fac[[1]]) %>% as_tibble() %>% ggplot(aes(x=V2, y=V6)) + geom_point() + xlab("") + ylab("Modelled loading (Comp. 2)")
plotlist_cmtf[[6]]  = cbind(Bnorm, cmtf_result$Fac[[2]]) %>% as_tibble() %>% ggplot(aes(x=V2, y=V6)) + geom_point() + xlab("") + ylab("")
plotlist_cmtf[[7]]  = cbind(Cnorm, cmtf_result$Fac[[3]]) %>% as_tibble() %>% ggplot(aes(x=V2, y=V6)) + geom_point() + xlab("") + ylab("")
plotlist_cmtf[[8]]  = cbind(Dnorm, cmtf_result$Fac[[4]]) %>% as_tibble() %>% ggplot(aes(x=V2, y=V6)) + geom_point() + xlab("") + ylab("")
plotlist_cmtf[[9]]  = cbind(Anorm, cmtf_result$Fac[[1]]) %>% as_tibble() %>% ggplot(aes(x=V3, y=V5)) + geom_point() + xlab("Simulated loading") + ylab("Modelled loading (Comp. 3)")
plotlist_cmtf[[10]] = cbind(Bnorm, cmtf_result$Fac[[2]]) %>% as_tibble() %>% ggplot(aes(x=V3, y=V5)) + geom_point() + xlab("Simulated loading") + ylab("")
plotlist_cmtf[[11]] = cbind(Cnorm, cmtf_result$Fac[[3]]) %>% as_tibble() %>% ggplot(aes(x=V3, y=V5)) + geom_point() + xlab("Simulated loading") + ylab("")
plotlist_cmtf[[12]] = cbind(Dnorm, cmtf_result$Fac[[4]]) %>% as_tibble() %>% ggplot(aes(x=V3, y=V5)) + geom_point() + xlab("Simulated loading") + ylab("")
plot = ggarrange(plotlist=plotlist_cmtf, nrow=3, ncol=4)
annotate_figure(plot, top = text_grob("CMTF model"))
abs(t(cmtf_result$Fac[[1]][,1]) %*% Anorm[,1]) / (norm(as.matrix(cmtf_result$Fac[[1]][,1]), "F") * norm(as.matrix(Anorm[,1]), "F"))
abs(t(cmtf_result$Fac[[1]][,3]) %*% Anorm[,2]) / (norm(as.matrix(cmtf_result$Fac[[1]][,3]), "F") * norm(as.matrix(Anorm[,2]), "F"))
abs(t(cmtf_result$Fac[[1]][,2]) %*% Anorm[,3]) / (norm(as.matrix(cmtf_result$Fac[[1]][,2]), "F") * norm(as.matrix(Anorm[,3]), "F"))
# CMTF best result
plotlist_acmtf = list()
plotlist_acmtf[[1]]  = cbind(Anorm, acmtf_result$Fac[[1]]) %>% as_tibble() %>% ggplot(aes(x=V1, y=V5)) + geom_point() + ggtitle("Subject mode (shared)") + xlab("") + ylab("Modelled loading (Comp. 1)")
plotlist_acmtf[[2]]  = cbind(Bnorm, acmtf_result$Fac[[2]]) %>% as_tibble() %>% ggplot(aes(x=V1, y=V5)) + geom_point() + ggtitle("Feature mode X1") + xlab("") + ylab("")
plotlist_acmtf[[3]]  = cbind(Cnorm, acmtf_result$Fac[[3]]) %>% as_tibble() %>% ggplot(aes(x=V1, y=V5)) + geom_point() + ggtitle("Condition mode X1") + xlab("") + ylab("")
plotlist_acmtf[[4]]  = cbind(Dnorm, acmtf_result$Fac[[4]]) %>% as_tibble() %>% ggplot(aes(x=V1, y=V5)) + geom_point() + ggtitle("Feature mode X2") + xlab("") + ylab("")
plotlist_acmtf[[5]]  = cbind(Anorm, acmtf_result$Fac[[1]]) %>% as_tibble() %>% ggplot(aes(x=V2, y=V4)) + geom_point() + xlab("") + ylab("Modelled loading (Comp. 2)")
plotlist_acmtf[[6]]  = cbind(Bnorm, acmtf_result$Fac[[2]]) %>% as_tibble() %>% ggplot(aes(x=V2, y=V4)) + geom_point() + xlab("") + ylab("")
plotlist_acmtf[[7]]  = cbind(Cnorm, acmtf_result$Fac[[3]]) %>% as_tibble() %>% ggplot(aes(x=V2, y=V4)) + geom_point() + xlab("") + ylab("")
plotlist_acmtf[[8]]  = cbind(Dnorm, acmtf_result$Fac[[4]]) %>% as_tibble() %>% ggplot(aes(x=V2, y=V4)) + geom_point() + xlab("") + ylab("")
plotlist_acmtf[[9]]  = cbind(Anorm, acmtf_result$Fac[[1]]) %>% as_tibble() %>% ggplot(aes(x=V3, y=V6)) + geom_point() + xlab("Simulated loading") + ylab("Modelled loading (Comp. 3)")
plotlist_acmtf[[10]] = cbind(Bnorm, acmtf_result$Fac[[2]]) %>% as_tibble() %>% ggplot(aes(x=V3, y=V6)) + geom_point() + xlab("Simulated loading") + ylab("")
plotlist_acmtf[[11]] = cbind(Cnorm, acmtf_result$Fac[[3]]) %>% as_tibble() %>% ggplot(aes(x=V3, y=V6)) + geom_point() + xlab("Simulated loading") + ylab("")
plotlist_acmtf[[12]] = cbind(Dnorm, acmtf_result$Fac[[4]]) %>% as_tibble() %>% ggplot(aes(x=V3, y=V6)) + geom_point() + xlab("Simulated loading") + ylab("")
plot = ggarrange(plotlist=plotlist_acmtf, nrow=3, ncol=4)
annotate_figure(plot, top = text_grob("acmtf model"))
abs(t(acmtf_result$Fac[[1]][,2]) %*% Anorm[,1]) / (norm(as.matrix(acmtf_result$Fac[[1]][,2]), "F") * norm(as.matrix(Anorm[,1]), "F"))
abs(t(acmtf_result$Fac[[1]][,1]) %*% Anorm[,2]) / (norm(as.matrix(acmtf_result$Fac[[1]][,1]), "F") * norm(as.matrix(Anorm[,2]), "F"))
abs(t(acmtf_result$Fac[[1]][,3]) %*% Anorm[,3]) / (norm(as.matrix(acmtf_result$Fac[[1]][,3]), "F") * norm(as.matrix(Anorm[,3]), "F"))
cor(Anorm, acmtf_result$Fac[[1]])
# CMTF best result
plotlist_acmtf = list()
plotlist_acmtf[[1]]  = cbind(Anorm, acmtf_result$Fac[[1]]) %>% as_tibble() %>% ggplot(aes(x=V1, y=V6)) + geom_point() + ggtitle("Subject mode (shared)") + xlab("") + ylab("Modelled loading (Comp. 1)")
plotlist_acmtf[[2]]  = cbind(Bnorm, acmtf_result$Fac[[2]]) %>% as_tibble() %>% ggplot(aes(x=V1, y=V6)) + geom_point() + ggtitle("Feature mode X1") + xlab("") + ylab("")
plotlist_acmtf[[3]]  = cbind(Cnorm, acmtf_result$Fac[[3]]) %>% as_tibble() %>% ggplot(aes(x=V1, y=V6)) + geom_point() + ggtitle("Condition mode X1") + xlab("") + ylab("")
plotlist_acmtf[[4]]  = cbind(Dnorm, acmtf_result$Fac[[4]]) %>% as_tibble() %>% ggplot(aes(x=V1, y=V6)) + geom_point() + ggtitle("Feature mode X2") + xlab("") + ylab("")
plotlist_acmtf[[5]]  = cbind(Anorm, acmtf_result$Fac[[1]]) %>% as_tibble() %>% ggplot(aes(x=V2, y=V5)) + geom_point() + xlab("") + ylab("Modelled loading (Comp. 2)")
plotlist_acmtf[[6]]  = cbind(Bnorm, acmtf_result$Fac[[2]]) %>% as_tibble() %>% ggplot(aes(x=V2, y=V5)) + geom_point() + xlab("") + ylab("")
plotlist_acmtf[[7]]  = cbind(Cnorm, acmtf_result$Fac[[3]]) %>% as_tibble() %>% ggplot(aes(x=V2, y=V5)) + geom_point() + xlab("") + ylab("")
plotlist_acmtf[[8]]  = cbind(Dnorm, acmtf_result$Fac[[4]]) %>% as_tibble() %>% ggplot(aes(x=V2, y=V5)) + geom_point() + xlab("") + ylab("")
plotlist_acmtf[[9]]  = cbind(Anorm, acmtf_result$Fac[[1]]) %>% as_tibble() %>% ggplot(aes(x=V3, y=V4)) + geom_point() + xlab("Simulated loading") + ylab("Modelled loading (Comp. 3)")
plotlist_acmtf[[10]] = cbind(Bnorm, acmtf_result$Fac[[2]]) %>% as_tibble() %>% ggplot(aes(x=V3, y=V4)) + geom_point() + xlab("Simulated loading") + ylab("")
plotlist_acmtf[[11]] = cbind(Cnorm, acmtf_result$Fac[[3]]) %>% as_tibble() %>% ggplot(aes(x=V3, y=V4)) + geom_point() + xlab("Simulated loading") + ylab("")
plotlist_acmtf[[12]] = cbind(Dnorm, acmtf_result$Fac[[4]]) %>% as_tibble() %>% ggplot(aes(x=V3, y=V4)) + geom_point() + xlab("Simulated loading") + ylab("")
plot = ggarrange(plotlist=plotlist_acmtf, nrow=3, ncol=4)
annotate_figure(plot, top = text_grob("acmtf model"))
abs(t(acmtf_result$Fac[[1]][,2]) %*% Anorm[,1]) / (norm(as.matrix(acmtf_result$Fac[[1]][,2]), "F") * norm(as.matrix(Anorm[,1]), "F"))
abs(t(acmtf_result$Fac[[1]][,1]) %*% Anorm[,2]) / (norm(as.matrix(acmtf_result$Fac[[1]][,1]), "F") * norm(as.matrix(Anorm[,2]), "F"))
abs(t(acmtf_result$Fac[[1]][,3]) %*% Anorm[,3]) / (norm(as.matrix(acmtf_result$Fac[[1]][,3]), "F") * norm(as.matrix(Anorm[,3]), "F"))
# CMTF best result
plotlist_acmtf = list()
plotlist_acmtf[[1]]  = cbind(Anorm, acmtf_result$Fac[[1]]) %>% as_tibble() %>% ggplot(aes(x=V1, y=V6)) + geom_point() + ggtitle("Subject mode (shared)") + xlab("") + ylab("Modelled loading (Comp. 1)")
plotlist_acmtf[[2]]  = cbind(Bnorm, acmtf_result$Fac[[2]]) %>% as_tibble() %>% ggplot(aes(x=V1, y=V6)) + geom_point() + ggtitle("Feature mode X1") + xlab("") + ylab("")
plotlist_acmtf[[3]]  = cbind(Cnorm, acmtf_result$Fac[[3]]) %>% as_tibble() %>% ggplot(aes(x=V1, y=V6)) + geom_point() + ggtitle("Condition mode X1") + xlab("") + ylab("")
plotlist_acmtf[[4]]  = cbind(Dnorm, acmtf_result$Fac[[4]]) %>% as_tibble() %>% ggplot(aes(x=V1, y=V6)) + geom_point() + ggtitle("Feature mode X2") + xlab("") + ylab("")
plotlist_acmtf[[5]]  = cbind(Anorm, acmtf_result$Fac[[1]]) %>% as_tibble() %>% ggplot(aes(x=V2, y=V5)) + geom_point() + xlab("") + ylab("Modelled loading (Comp. 2)")
plotlist_acmtf[[6]]  = cbind(Bnorm, acmtf_result$Fac[[2]]) %>% as_tibble() %>% ggplot(aes(x=V2, y=V5)) + geom_point() + xlab("") + ylab("")
plotlist_acmtf[[7]]  = cbind(Cnorm, acmtf_result$Fac[[3]]) %>% as_tibble() %>% ggplot(aes(x=V2, y=V5)) + geom_point() + xlab("") + ylab("")
plotlist_acmtf[[8]]  = cbind(Dnorm, acmtf_result$Fac[[4]]) %>% as_tibble() %>% ggplot(aes(x=V2, y=V5)) + geom_point() + xlab("") + ylab("")
plotlist_acmtf[[9]]  = cbind(Anorm, acmtf_result$Fac[[1]]) %>% as_tibble() %>% ggplot(aes(x=V3, y=V4)) + geom_point() + xlab("Simulated loading") + ylab("Modelled loading (Comp. 3)")
plotlist_acmtf[[10]] = cbind(Bnorm, acmtf_result$Fac[[2]]) %>% as_tibble() %>% ggplot(aes(x=V3, y=V4)) + geom_point() + xlab("Simulated loading") + ylab("")
plotlist_acmtf[[11]] = cbind(Cnorm, acmtf_result$Fac[[3]]) %>% as_tibble() %>% ggplot(aes(x=V3, y=V4)) + geom_point() + xlab("Simulated loading") + ylab("")
plotlist_acmtf[[12]] = cbind(Dnorm, acmtf_result$Fac[[4]]) %>% as_tibble() %>% ggplot(aes(x=V3, y=V4)) + geom_point() + xlab("Simulated loading") + ylab("")
plot = ggarrange(plotlist=plotlist_acmtf, nrow=3, ncol=4)
annotate_figure(plot, top = text_grob("acmtf model"))
abs(t(acmtf_result$Fac[[1]][,3]) %*% Anorm[,1]) / (norm(as.matrix(acmtf_result$Fac[[1]][,3]), "F") * norm(as.matrix(Anorm[,1]), "F"))
abs(t(acmtf_result$Fac[[1]][,2]) %*% Anorm[,2]) / (norm(as.matrix(acmtf_result$Fac[[1]][,2]), "F") * norm(as.matrix(Anorm[,2]), "F"))
abs(t(acmtf_result$Fac[[1]][,1]) %*% Anorm[,3]) / (norm(as.matrix(acmtf_result$Fac[[1]][,1]), "F") * norm(as.matrix(Anorm[,3]), "F"))
library(CMTFtoolbox)
library(tidyverse)
library(ggpubr)
set.seed(123)
R = 3
I = 50
J = 30
K = 40
M = 20
modes = list(c(1,2,3), c(1,4))
A = array(rnorm(I*R), c(I, R))  # shared subject mode
Anorm = sweep(A, 2, apply(A, 2, function(x){norm(as.matrix(x), "F")}), FUN="/")
B = array(rnorm(J*R), c(J, R))  # distinct feature mode of X1
Bnorm = sweep(B, 2, apply(B, 2, function(x){norm(as.matrix(x), "F")}), FUN="/")
C = array(rnorm(K*R), c(K, R))  # distinct condition mode of X1
Cnorm = sweep(C, 2, apply(C, 2, function(x){norm(as.matrix(x), "F")}), FUN="/")
D = array(rnorm(M*R), c(M, R))  # distinct feature mode of X2
Dnorm = sweep(D, 2, apply(D, 2, function(x){norm(as.matrix(x), "F")}), FUN="/")
lambdas = array(c(1, 1, 0, 1, 1, 1), c(2,3))
df1 = array(0L, c(I, J, K))
df2 = array(0L, c(I, M))
for(i in 1:R){
df1 = df1 + lambdas[1,i] * reinflateTensor(Anorm[,i], Bnorm[,i], Cnorm[,i])
df2 = df2 + lambdas[2,i] * reinflateMatrix(Anorm[,i], Dnorm[,i])
}
datasets = list(df1, df2)
Z = setupCMTFdata(datasets, modes, normalize=TRUE)
cmtf_result = cmtf_opt(Z, 3, nstart=10, numCores=10)
acmtf_result = acmtf_opt(Z, 3, nstart=10, numCores=10)
# CMTF best result
plotlist_cmtf = list()
plotlist_cmtf[[1]]  = cbind(Anorm, cmtf_result$Fac[[1]]) %>% as_tibble() %>% ggplot(aes(x=V1, y=V4)) + geom_point() + ggtitle("Subject mode (shared)") + xlab("") + ylab("Modelled loading (Comp. 1)")
plotlist_cmtf[[2]]  = cbind(Bnorm, cmtf_result$Fac[[2]]) %>% as_tibble() %>% ggplot(aes(x=V1, y=V4)) + geom_point() + ggtitle("Feature mode X1") + xlab("") + ylab("")
plotlist_cmtf[[3]]  = cbind(Cnorm, cmtf_result$Fac[[3]]) %>% as_tibble() %>% ggplot(aes(x=V1, y=V4)) + geom_point() + ggtitle("Condition mode X1") + xlab("") + ylab("")
plotlist_cmtf[[4]]  = cbind(Dnorm, cmtf_result$Fac[[4]]) %>% as_tibble() %>% ggplot(aes(x=V1, y=V4)) + geom_point() + ggtitle("Feature mode X2") + xlab("") + ylab("")
plotlist_cmtf[[5]]  = cbind(Anorm, cmtf_result$Fac[[1]]) %>% as_tibble() %>% ggplot(aes(x=V2, y=V6)) + geom_point() + xlab("") + ylab("Modelled loading (Comp. 2)")
plotlist_cmtf[[6]]  = cbind(Bnorm, cmtf_result$Fac[[2]]) %>% as_tibble() %>% ggplot(aes(x=V2, y=V6)) + geom_point() + xlab("") + ylab("")
plotlist_cmtf[[7]]  = cbind(Cnorm, cmtf_result$Fac[[3]]) %>% as_tibble() %>% ggplot(aes(x=V2, y=V6)) + geom_point() + xlab("") + ylab("")
plotlist_cmtf[[8]]  = cbind(Dnorm, cmtf_result$Fac[[4]]) %>% as_tibble() %>% ggplot(aes(x=V2, y=V6)) + geom_point() + xlab("") + ylab("")
plotlist_cmtf[[9]]  = cbind(Anorm, cmtf_result$Fac[[1]]) %>% as_tibble() %>% ggplot(aes(x=V3, y=V5)) + geom_point() + xlab("Simulated loading") + ylab("Modelled loading (Comp. 3)")
plotlist_cmtf[[10]] = cbind(Bnorm, cmtf_result$Fac[[2]]) %>% as_tibble() %>% ggplot(aes(x=V3, y=V5)) + geom_point() + xlab("Simulated loading") + ylab("")
plotlist_cmtf[[11]] = cbind(Cnorm, cmtf_result$Fac[[3]]) %>% as_tibble() %>% ggplot(aes(x=V3, y=V5)) + geom_point() + xlab("Simulated loading") + ylab("")
plotlist_cmtf[[12]] = cbind(Dnorm, cmtf_result$Fac[[4]]) %>% as_tibble() %>% ggplot(aes(x=V3, y=V5)) + geom_point() + xlab("Simulated loading") + ylab("")
plot = ggarrange(plotlist=plotlist_cmtf, nrow=3, ncol=4)
annotate_figure(plot, top = text_grob("CMTF model"))
abs(t(cmtf_result$Fac[[1]][,1]) %*% Anorm[,1]) / (norm(as.matrix(cmtf_result$Fac[[1]][,1]), "F") * norm(as.matrix(Anorm[,1]), "F"))
abs(t(cmtf_result$Fac[[1]][,3]) %*% Anorm[,2]) / (norm(as.matrix(cmtf_result$Fac[[1]][,3]), "F") * norm(as.matrix(Anorm[,2]), "F"))
abs(t(cmtf_result$Fac[[1]][,2]) %*% Anorm[,3]) / (norm(as.matrix(cmtf_result$Fac[[1]][,2]), "F") * norm(as.matrix(Anorm[,3]), "F"))
# CMTF best result
plotlist_acmtf = list()
plotlist_acmtf[[1]]  = cbind(Anorm, acmtf_result$Fac[[1]]) %>% as_tibble() %>% ggplot(aes(x=V1, y=V6)) + geom_point() + ggtitle("Subject mode (shared)") + xlab("") + ylab("Modelled loading (Comp. 1)")
plotlist_acmtf[[2]]  = cbind(Bnorm, acmtf_result$Fac[[2]]) %>% as_tibble() %>% ggplot(aes(x=V1, y=V6)) + geom_point() + ggtitle("Feature mode X1") + xlab("") + ylab("")
plotlist_acmtf[[3]]  = cbind(Cnorm, acmtf_result$Fac[[3]]) %>% as_tibble() %>% ggplot(aes(x=V1, y=V6)) + geom_point() + ggtitle("Condition mode X1") + xlab("") + ylab("")
plotlist_acmtf[[4]]  = cbind(Dnorm, acmtf_result$Fac[[4]]) %>% as_tibble() %>% ggplot(aes(x=V1, y=V6)) + geom_point() + ggtitle("Feature mode X2") + xlab("") + ylab("")
plotlist_acmtf[[5]]  = cbind(Anorm, acmtf_result$Fac[[1]]) %>% as_tibble() %>% ggplot(aes(x=V2, y=V5)) + geom_point() + xlab("") + ylab("Modelled loading (Comp. 2)")
plotlist_acmtf[[6]]  = cbind(Bnorm, acmtf_result$Fac[[2]]) %>% as_tibble() %>% ggplot(aes(x=V2, y=V5)) + geom_point() + xlab("") + ylab("")
plotlist_acmtf[[7]]  = cbind(Cnorm, acmtf_result$Fac[[3]]) %>% as_tibble() %>% ggplot(aes(x=V2, y=V5)) + geom_point() + xlab("") + ylab("")
plotlist_acmtf[[8]]  = cbind(Dnorm, acmtf_result$Fac[[4]]) %>% as_tibble() %>% ggplot(aes(x=V2, y=V5)) + geom_point() + xlab("") + ylab("")
plotlist_acmtf[[9]]  = cbind(Anorm, acmtf_result$Fac[[1]]) %>% as_tibble() %>% ggplot(aes(x=V3, y=V4)) + geom_point() + xlab("Simulated loading") + ylab("Modelled loading (Comp. 3)")
plotlist_acmtf[[10]] = cbind(Bnorm, acmtf_result$Fac[[2]]) %>% as_tibble() %>% ggplot(aes(x=V3, y=V4)) + geom_point() + xlab("Simulated loading") + ylab("")
plotlist_acmtf[[11]] = cbind(Cnorm, acmtf_result$Fac[[3]]) %>% as_tibble() %>% ggplot(aes(x=V3, y=V4)) + geom_point() + xlab("Simulated loading") + ylab("")
plotlist_acmtf[[12]] = cbind(Dnorm, acmtf_result$Fac[[4]]) %>% as_tibble() %>% ggplot(aes(x=V3, y=V4)) + geom_point() + xlab("Simulated loading") + ylab("")
plot = ggarrange(plotlist=plotlist_acmtf, nrow=3, ncol=4)
annotate_figure(plot, top = text_grob("acmtf model"))
abs(t(acmtf_result$Fac[[1]][,3]) %*% Anorm[,1]) / (norm(as.matrix(acmtf_result$Fac[[1]][,3]), "F") * norm(as.matrix(Anorm[,1]), "F"))
abs(t(acmtf_result$Fac[[1]][,2]) %*% Anorm[,2]) / (norm(as.matrix(acmtf_result$Fac[[1]][,2]), "F") * norm(as.matrix(Anorm[,2]), "F"))
abs(t(acmtf_result$Fac[[1]][,1]) %*% Anorm[,3]) / (norm(as.matrix(acmtf_result$Fac[[1]][,1]), "F") * norm(as.matrix(Anorm[,3]), "F"))
cor(Anorm, acmtf_result$Fac[[1]])
# CMTF best result
plotlist_acmtf = list()
plotlist_acmtf[[1]]  = cbind(Anorm, acmtf_result$Fac[[1]]) %>% as_tibble() %>% ggplot(aes(x=V1, y=V6)) + geom_point() + ggtitle("Subject mode (shared)") + xlab("") + ylab("Modelled loading (Comp. 1)")
plotlist_acmtf[[2]]  = cbind(Bnorm, acmtf_result$Fac[[2]]) %>% as_tibble() %>% ggplot(aes(x=V1, y=V6)) + geom_point() + ggtitle("Feature mode X1") + xlab("") + ylab("")
plotlist_acmtf[[3]]  = cbind(Cnorm, acmtf_result$Fac[[3]]) %>% as_tibble() %>% ggplot(aes(x=V1, y=V6)) + geom_point() + ggtitle("Condition mode X1") + xlab("") + ylab("")
plotlist_acmtf[[4]]  = cbind(Dnorm, acmtf_result$Fac[[4]]) %>% as_tibble() %>% ggplot(aes(x=V1, y=V6)) + geom_point() + ggtitle("Feature mode X2") + xlab("") + ylab("")
plotlist_acmtf[[5]]  = cbind(Anorm, acmtf_result$Fac[[1]]) %>% as_tibble() %>% ggplot(aes(x=V2, y=V4)) + geom_point() + xlab("") + ylab("Modelled loading (Comp. 2)")
plotlist_acmtf[[6]]  = cbind(Bnorm, acmtf_result$Fac[[2]]) %>% as_tibble() %>% ggplot(aes(x=V2, y=V4)) + geom_point() + xlab("") + ylab("")
plotlist_acmtf[[7]]  = cbind(Cnorm, acmtf_result$Fac[[3]]) %>% as_tibble() %>% ggplot(aes(x=V2, y=V4)) + geom_point() + xlab("") + ylab("")
plotlist_acmtf[[8]]  = cbind(Dnorm, acmtf_result$Fac[[4]]) %>% as_tibble() %>% ggplot(aes(x=V2, y=V4)) + geom_point() + xlab("") + ylab("")
plotlist_acmtf[[9]]  = cbind(Anorm, acmtf_result$Fac[[1]]) %>% as_tibble() %>% ggplot(aes(x=V3, y=V5)) + geom_point() + xlab("Simulated loading") + ylab("Modelled loading (Comp. 3)")
plotlist_acmtf[[10]] = cbind(Bnorm, acmtf_result$Fac[[2]]) %>% as_tibble() %>% ggplot(aes(x=V3, y=V5)) + geom_point() + xlab("Simulated loading") + ylab("")
plotlist_acmtf[[11]] = cbind(Cnorm, acmtf_result$Fac[[3]]) %>% as_tibble() %>% ggplot(aes(x=V3, y=V5)) + geom_point() + xlab("Simulated loading") + ylab("")
plotlist_acmtf[[12]] = cbind(Dnorm, acmtf_result$Fac[[4]]) %>% as_tibble() %>% ggplot(aes(x=V3, y=V5)) + geom_point() + xlab("Simulated loading") + ylab("")
plot = ggarrange(plotlist=plotlist_acmtf, nrow=3, ncol=4)
annotate_figure(plot, top = text_grob("acmtf model"))
abs(t(acmtf_result$Fac[[1]][,3]) %*% Anorm[,1]) / (norm(as.matrix(acmtf_result$Fac[[1]][,3]), "F") * norm(as.matrix(Anorm[,1]), "F"))
abs(t(acmtf_result$Fac[[1]][,2]) %*% Anorm[,2]) / (norm(as.matrix(acmtf_result$Fac[[1]][,2]), "F") * norm(as.matrix(Anorm[,2]), "F"))
abs(t(acmtf_result$Fac[[1]][,1]) %*% Anorm[,3]) / (norm(as.matrix(acmtf_result$Fac[[1]][,1]), "F") * norm(as.matrix(Anorm[,3]), "F"))
cor(Anorm, acmtf_result$Fac[[1]])
# CMTF best result
plotlist_acmtf = list()
plotlist_acmtf[[1]]  = cbind(Anorm, acmtf_result$Fac[[1]]) %>% as_tibble() %>% ggplot(aes(x=V1, y=V5)) + geom_point() + ggtitle("Subject mode (shared)") + xlab("") + ylab("Modelled loading (Comp. 1)")
plotlist_acmtf[[2]]  = cbind(Bnorm, acmtf_result$Fac[[2]]) %>% as_tibble() %>% ggplot(aes(x=V1, y=V5)) + geom_point() + ggtitle("Feature mode X1") + xlab("") + ylab("")
plotlist_acmtf[[3]]  = cbind(Cnorm, acmtf_result$Fac[[3]]) %>% as_tibble() %>% ggplot(aes(x=V1, y=V5)) + geom_point() + ggtitle("Condition mode X1") + xlab("") + ylab("")
plotlist_acmtf[[4]]  = cbind(Dnorm, acmtf_result$Fac[[4]]) %>% as_tibble() %>% ggplot(aes(x=V1, y=V5)) + geom_point() + ggtitle("Feature mode X2") + xlab("") + ylab("")
plotlist_acmtf[[5]]  = cbind(Anorm, acmtf_result$Fac[[1]]) %>% as_tibble() %>% ggplot(aes(x=V2, y=V6)) + geom_point() + xlab("") + ylab("Modelled loading (Comp. 2)")
plotlist_acmtf[[6]]  = cbind(Bnorm, acmtf_result$Fac[[2]]) %>% as_tibble() %>% ggplot(aes(x=V2, y=V6)) + geom_point() + xlab("") + ylab("")
plotlist_acmtf[[7]]  = cbind(Cnorm, acmtf_result$Fac[[3]]) %>% as_tibble() %>% ggplot(aes(x=V2, y=V6)) + geom_point() + xlab("") + ylab("")
plotlist_acmtf[[8]]  = cbind(Dnorm, acmtf_result$Fac[[4]]) %>% as_tibble() %>% ggplot(aes(x=V2, y=V6)) + geom_point() + xlab("") + ylab("")
plotlist_acmtf[[9]]  = cbind(Anorm, acmtf_result$Fac[[1]]) %>% as_tibble() %>% ggplot(aes(x=V3, y=V4)) + geom_point() + xlab("Simulated loading") + ylab("Modelled loading (Comp. 3)")
plotlist_acmtf[[10]] = cbind(Bnorm, acmtf_result$Fac[[2]]) %>% as_tibble() %>% ggplot(aes(x=V3, y=V4)) + geom_point() + xlab("Simulated loading") + ylab("")
plotlist_acmtf[[11]] = cbind(Cnorm, acmtf_result$Fac[[3]]) %>% as_tibble() %>% ggplot(aes(x=V3, y=V4)) + geom_point() + xlab("Simulated loading") + ylab("")
plotlist_acmtf[[12]] = cbind(Dnorm, acmtf_result$Fac[[4]]) %>% as_tibble() %>% ggplot(aes(x=V3, y=V4)) + geom_point() + xlab("Simulated loading") + ylab("")
plot = ggarrange(plotlist=plotlist_acmtf, nrow=3, ncol=4)
annotate_figure(plot, top = text_grob("acmtf model"))
abs(t(acmtf_result$Fac[[1]][,3]) %*% Anorm[,1]) / (norm(as.matrix(acmtf_result$Fac[[1]][,3]), "F") * norm(as.matrix(Anorm[,1]), "F"))
abs(t(acmtf_result$Fac[[1]][,2]) %*% Anorm[,2]) / (norm(as.matrix(acmtf_result$Fac[[1]][,2]), "F") * norm(as.matrix(Anorm[,2]), "F"))
abs(t(acmtf_result$Fac[[1]][,1]) %*% Anorm[,3]) / (norm(as.matrix(acmtf_result$Fac[[1]][,1]), "F") * norm(as.matrix(Anorm[,3]), "F"))
abs(t(acmtf_result$Fac[[1]][,2]) %*% Anorm[,1]) / (norm(as.matrix(acmtf_result$Fac[[1]][,2]), "F") * norm(as.matrix(Anorm[,1]), "F"))
abs(t(acmtf_result$Fac[[1]][,3]) %*% Anorm[,2]) / (norm(as.matrix(acmtf_result$Fac[[1]][,3]), "F") * norm(as.matrix(Anorm[,2]), "F"))
abs(t(acmtf_result$Fac[[1]][,1]) %*% Anorm[,3]) / (norm(as.matrix(acmtf_result$Fac[[1]][,1]), "F") * norm(as.matrix(Anorm[,3]), "F"))
acmtf_result$Fac[[5]]
lambdas
annotate_figure(plot, top = text_grob("acmtf model"))
library(CMTFtoolbox)
library(tidyverse)
library(ggpubr)
set.seed(123)
R = 3
I = 50
J = 30
K = 40
M = 20
modes = list(c(1,2,3), c(1,4))
A = array(rnorm(I*R), c(I, R))  # shared subject mode
Anorm = sweep(A, 2, apply(A, 2, function(x){norm(as.matrix(x), "F")}), FUN="/")
B = array(rnorm(J*R), c(J, R))  # distinct feature mode of X1
Bnorm = sweep(B, 2, apply(B, 2, function(x){norm(as.matrix(x), "F")}), FUN="/")
C = array(rnorm(K*R), c(K, R))  # distinct condition mode of X1
Cnorm = sweep(C, 2, apply(C, 2, function(x){norm(as.matrix(x), "F")}), FUN="/")
D = array(rnorm(M*R), c(M, R))  # distinct feature mode of X2
Dnorm = sweep(D, 2, apply(D, 2, function(x){norm(as.matrix(x), "F")}), FUN="/")
lambdas = array(c(1, 1, 0, 1, 1, 1), c(2,3))
df1 = array(0L, c(I, J, K))
df2 = array(0L, c(I, M))
for(i in 1:R){
df1 = df1 + lambdas[1,i] * reinflateTensor(Anorm[,i], Bnorm[,i], Cnorm[,i])
df2 = df2 + lambdas[2,i] * reinflateMatrix(Anorm[,i], Dnorm[,i])
}
datasets = list(df1, df2)
Z = setupCMTFdata(datasets, modes, normalize=TRUE)
cmtf_result = cmtf_opt(Z, 3, nstart=100, numCores=12, allOutput=TRUE)
acmtf_result = acmtf_opt(Z, 3, nstart=100, numCores=12, allOutput=TRUE)
cmtf_result[[1]]$Fac
acmtf_result[[1]]$Fac[[5]]
temp = acmtf_result[[1]]$Fac[[5]]
colnames(temp) = c("Component_1", "Component_2", "Component_3")
temp %>% pivot_longer(everything())
temp %>% as_tibble() %>% pivot_longer(everything())
acmtf_lambdas = acmtf_result[[1]]$Fac[[5]]
colnames(acmtf_lambdas) = c("Component_1", "Component_2", "Component_3")
acmtf_lambdas = acmtf_lambdas %>% as_tibble() %>% pivot_longer(everything())
for(i in 2:length(acmtf_result)){
temp = acmtf_result[[i]]$Fac[[5]]
colnames(temp) = c("Component_1", "Component_2", "Component_3")
temp = temp %>% as_tibble() %>% pivot_longer(everything())
acmtf_lambdas = rbind(acmtf_lambdas, temp)
}
acmtf_lamdbas
acmtf_lambdas
acmtf_lambdas %>% ggplot(aes(x=as.factor(name),y=value)) + geom_boxplot()
acmtf_lambdas = acmtf_result[[1]]$Fac[[5]]
acmtf_lambdas
colMeans(acmtf_lambdas)
acmtf_lambdas = abs(acmtf_result[[1]]$Fac[[5]])
colMeans(acmtf_lambdas)
cor(Anorm, acmtf_result[[1]]$Fac[[1]])
Fac = acmtf_result[[1]]$Fac
matchScore = 1:numComponents
Fac = acmtf_result[[1]]$Fac
numComponents = ncol(Fac[[1]])
matchScore = 1:numComponents
for(i in 1:numComponents){
a_hat = Fac[[1]][,i]
proposedMatchScore = 1:numComponents
for(j in 1:numComponents){
a = Anorm[,j]
proposedMatchScore[j] = t(a_hat) * a / (norm(a_hat, "2") * norm(a, "2"))
}
matchScore[i] = max(proposedMatchScore)
}
Fac = acmtf_result[[1]]$Fac
numComponents = ncol(Fac[[1]])
matchScore = 1:numComponents
for(i in 1:numComponents){
a_hat = Fac[[1]][,i]
proposedMatchScore = 1:numComponents
for(j in 1:numComponents){
a = Anorm[,j]
proposedMatchScore[j] = (t(a_hat) * a) / (norm(a_hat, "2") * norm(a, "2"))
}
matchScore[i] = max(proposedMatchScore)
}
i=1
j=1
Fac = acmtf_result[[1]]$Fac
numComponents = ncol(Fac[[1]])
matchScore = 1:numComponents
a_hat = Fac[[1]][,i]
proposedMatchScore = 1:numComponents
a_hat
a = Anorm[,j]
a
t(a_hat) %*% a
Fac = acmtf_result[[1]]$Fac
numComponents = ncol(Fac[[1]])
matchScore = 1:numComponents
for(i in 1:numComponents){
a_hat = Fac[[1]][,i]
proposedMatchScore = 1:numComponents
for(j in 1:numComponents){
a = Anorm[,j]
proposedMatchScore[j] = (t(a_hat) %*% a) / (norm(a_hat, "2") * norm(a, "2"))
}
matchScore[i] = max(proposedMatchScore)
}
matchScore
i=2
a_hat = Fac[[1]][,i]
proposedMatchScore = 1:numComponents
for(j in 1:numComponents){
a = Anorm[,j]
proposedMatchScore[j] = (t(a_hat) %*% a) / (norm(a_hat, "2") * norm(a, "2"))
}
