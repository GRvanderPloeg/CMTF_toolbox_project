---
title: "Rasmus"
output: html_document
date: "2024-08-22"
---

```{r setup, include=FALSE}
library(tidyverse)
library(ggplot2)
library(stringr)
library(parafac4microbiome)
library(CMTFtoolbox)
```




```{r check FMS}
# FMS_result = ncrossreg(Jakobsen2025$Z, Jakobsen2025$homogenizedSubjectMetadata$BMI, maxNumComponents=10, pi=0.95, nstart=100, numCores=parallel::detectCores())
```

```{r run ACMTF}
model = acmtfr_opt(Jakobsen2025$Z, Jakobsen2025$homogenizedSubjectMetadata$BMI, 1, nstart=12, numCores=12, pi=1)

```

```{r plot the model}
a = cbind(model$Fac[[1]], homogenized_subjectMeta) %>% as_tibble() %>% arrange(BMI.group, subject) %>% mutate(index=1:nrow(.)) %>% ggplot(aes(x=index,y=`1`,fill=as.factor(BMI.group))) + geom_bar(stat="identity") + theme(legend.position="none")
b = cbind(model$Fac[[2]], faeces_taxonomy) %>% as_tibble() %>% arrange(V2, V3, V4, V5, V6, V7, V1) %>% mutate(index=1:nrow(.)) %>% ggplot(aes(x=index,y=`1`,fill=as.factor(V3))) + geom_bar(stat="identity") + theme(legend.position="none")
c = model$Fac[[3]] %>% as_tibble() %>% mutate(index=1:nrow(.)) %>% ggplot(aes(x=index,y=V1)) + geom_line()
d = cbind(model$Fac[[4]], milk_taxonomy) %>% as_tibble() %>% arrange(V2, V3, V4, V5, V6, V7, V1) %>% mutate(index=1:nrow(.)) %>% ggplot(aes(x=index,y=`1`,fill=as.factor(V3))) + geom_bar(stat="identity") + theme(legend.position="none")
e = model$Fac[[5]] %>% as_tibble() %>% mutate(index=1:nrow(.)) %>% ggplot(aes(x=index,y=V1)) + geom_line()
f = cbind(model$Fac[[6]], milkMetab_taxonomy) %>% as_tibble() %>% arrange(X.CAS) %>% mutate(index=1:nrow(.)) %>% ggplot(aes(x=index,y=`1`)) + geom_bar(stat="identity") + theme(legend.position="none")
g = model$Fac[[7]] %>% as_tibble() %>% mutate(index=1:nrow(.)) %>% ggplot(aes(x=index,y=V1)) + geom_line()

h = cbind(model$Fac[[1]], homogenized_subjectMeta) %>% as_tibble() %>% arrange(BMI.group, subject) %>% mutate(index=1:nrow(.)) %>% ggplot(aes(x=index,y=`2`,fill=as.factor(BMI.group))) + geom_bar(stat="identity") + theme(legend.position="none")
i = cbind(model$Fac[[2]], faeces_taxonomy) %>% as_tibble() %>% arrange(V2, V3, V4, V5, V6, V7, V1) %>% mutate(index=1:nrow(.)) %>% ggplot(aes(x=index,y=`2`,fill=as.factor(V3))) + geom_bar(stat="identity") + theme(legend.position="none")
j = model$Fac[[3]] %>% as_tibble() %>% mutate(index=1:nrow(.)) %>% ggplot(aes(x=index,y=V2)) + geom_line()
k = cbind(model$Fac[[4]], milk_taxonomy) %>% as_tibble() %>% arrange(V2, V3, V4, V5, V6, V7, V1) %>% mutate(index=1:nrow(.)) %>% ggplot(aes(x=index,y=`2`,fill=as.factor(V3))) + geom_bar(stat="identity") + theme(legend.position="none")
l = model$Fac[[5]] %>% as_tibble() %>% mutate(index=1:nrow(.)) %>% ggplot(aes(x=index,y=V2)) + geom_line()
m = cbind(model$Fac[[6]], milkMetab_taxonomy) %>% as_tibble() %>% arrange(X.CAS) %>% mutate(index=1:nrow(.)) %>% ggplot(aes(x=index,y=`2`)) + geom_bar(stat="identity") + theme(legend.position="none")
n = model$Fac[[7]] %>% as_tibble() %>% mutate(index=1:nrow(.)) %>% ggplot(aes(x=index,y=V2)) + geom_line()

ggarrange(a,b,c,d,e,f,g,h,i,j,k,l,m,n, nrow=2, ncol=7)


```
